from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardButton, InlineKeyboardMarkup
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
import json
import time

from database import db
from config import ADMIN_IDS, DELIVERY_ZONES, SUPER_ADMIN_ID
from keyboards import (
    get_admin_keyboard, get_enhanced_admin_keyboard, get_admin_products_keyboard, 
    get_admin_orders_keyboard, get_admin_order_actions_keyboard,
    get_admin_categories_keyboard, get_category_selection_keyboard,
    get_change_status_keyboard, get_admin_management_keyboard,
    get_admins_list_keyboard
)
import i18n
from i18n import _
from anti_spam import anti_spam

router = Router()

# Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºĞ¸
class AdminStates(StatesGroup):
    waiting_product_name = State()
    waiting_product_price = State()
    waiting_product_description = State()
    waiting_product_quantity = State()
    waiting_product_photo = State()
    waiting_broadcast_message = State()
    waiting_category_name = State()
    waiting_category_emoji = State()
    waiting_category_description = State()
    waiting_admin_id = State()
    waiting_client_message = State()
    waiting_client_id = State()
    waiting_general_client_message = State()
    waiting_rejection_reason = State()

# Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ² (ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸)
def admin_filter(message_or_callback):
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°"""
    user_id = message_or_callback.from_user.id
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ² ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğµ Ğ¸Ğ»Ğ¸ Ğ² Ğ‘Ğ” (Ğ¿Ğ¾ĞºĞ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³)
    return user_id in ADMIN_IDS or user_id == SUPER_ADMIN_ID

# ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° (Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ñ…ĞµĞ½Ğ´Ğ»ĞµÑ€Ğ¾Ğ²)
async def is_admin(user_id: int) -> bool:
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ğ‘Ğ”"""
    return user_id in ADMIN_IDS or user_id == SUPER_ADMIN_ID or await db.is_admin_in_db(user_id)

# ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ
@router.callback_query(F.data == "admin_panel", admin_filter)
async def show_admin_panel(callback: CallbackQuery, state: FSMContext):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ½ÑƒÑ Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ"""
    # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ
    await state.clear()
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ¿Ğ¾ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğ¼ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²
    new_orders = await db.get_new_orders()
    checking_orders = await db.get_checking_orders()
    paid_orders = await db.get_paid_orders()
    shipping_orders = await db.get_shipping_orders()
    products = await db.get_all_products()
    
    import datetime
    current_time = datetime.datetime.now().strftime("%H:%M")
    
    user_id = callback.from_user.id
    
    try:
        await callback.message.edit_text(
            f"{_('admin.enhanced_panel', user_id=user_id)} <i>({current_time})</i>\n\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            f"{_('admin.order_statistics', user_id=user_id)}\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            f"{_('admin.new_orders', user_id=user_id)} <code>{len(new_orders):>8}</code>\n"
            f"{_('admin.checking_orders', user_id=user_id)} <code>{len(checking_orders):>10}</code>\n" 
            f"{_('admin.confirmed_orders', user_id=user_id)} <code>{len(paid_orders):>6}</code>\n"
            f"{_('admin.shipping_orders', user_id=user_id)} <code>{len(shipping_orders):>9}</code>\n"
            f"{_('admin.total_products', user_id=user_id)} <code>{len(products):>7}</code>\n\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            f"{_('admin.select_action', user_id=user_id)}",
            reply_markup=get_enhanced_admin_keyboard(user_id=user_id),
            parse_mode='HTML'
        )
    except Exception:
        # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        await callback.message.delete()
        await callback.message.answer(
            f"{_('admin.enhanced_panel', user_id=user_id)} <i>({current_time})</i>\n\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            f"{_('admin.order_statistics', user_id=user_id)}\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            f"{_('admin.new_orders', user_id=user_id)} <code>{len(new_orders):>8}</code>\n"
            f"{_('admin.checking_orders', user_id=user_id)} <code>{len(checking_orders):>10}</code>\n" 
            f"{_('admin.confirmed_orders', user_id=user_id)} <code>{len(paid_orders):>6}</code>\n"
            f"{_('admin.shipping_orders', user_id=user_id)} <code>{len(shipping_orders):>9}</code>\n"
            f"{_('admin.total_products', user_id=user_id)} <code>{len(products):>7}</code>\n\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            f"{_('admin.select_action', user_id=user_id)}",
            reply_markup=get_enhanced_admin_keyboard(user_id=user_id),
            parse_mode='HTML'
        )

# Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸
@router.callback_query(F.data == "admin_products", admin_filter)
async def admin_products_menu(callback: CallbackQuery):
    """ĞœĞµĞ½Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸"""
    products = await db.get_all_products()
    
    await callback.message.edit_text(
        f"ğŸ“¦ <b>Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸</b>\n\n"
        f"Ğ’ÑĞµĞ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²: {len(products)}",
        reply_markup=get_admin_products_keyboard(),
        parse_mode='HTML'
    )

@router.callback_query(F.data == "admin_edit_products", admin_filter)
async def admin_edit_products(callback: CallbackQuery):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"""
    products = await db.get_all_products()
    
    if not products:
        await callback.message.edit_text(
            "ğŸ“¦ <b>Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‚</b>\n\n"
            "Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ñ‡ĞµÑ€ĞµĞ· Ğ¼ĞµĞ½Ñ.",
            reply_markup=get_admin_products_keyboard(),
            parse_mode='HTML'
        )
        return
    
    keyboard = []
    for product in products:
        keyboard.append([
            InlineKeyboardButton(
                text=f"âœï¸ {product.name} - {product.price}â‚¾",
                callback_data=f"edit_product_{product.id}"
            )
        ])
    
    keyboard.append([InlineKeyboardButton(text="ğŸ”™ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸", callback_data="admin_products")])
    
    await callback.message.edit_text(
        "ğŸ“ <b>Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹</b>\n\n"
        "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=keyboard),
        parse_mode='HTML'
    )

@router.callback_query(F.data.startswith("edit_product_"), admin_filter)
async def edit_product_menu(callback: CallbackQuery):
    """ĞœĞµĞ½Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°"""
    product_id = int(callback.data.split("_")[2])
    product = await db.get_product(product_id)
    
    if not product:
        await callback.answer(_("common.not_found", user_id=callback.from_user.id), show_alert=True)
        return
    
    keyboard = [
        [InlineKeyboardButton(text="ğŸ“¦ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾", callback_data=f"edit_quantity_{product_id}")],
        [InlineKeyboardButton(text="ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾Ğ²Ğ°Ñ€", callback_data=f"delete_product_{product_id}")],
        [InlineKeyboardButton(text="ğŸ“¦ Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ/ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ", callback_data=f"toggle_stock_{product_id}")],
        [InlineKeyboardButton(text="ğŸ”™ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²", callback_data="admin_edit_products")]
    ]
    
    stock_status = "âœ… Ğ’ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸" if product.in_stock else "âŒ Ğ¡ĞºÑ€Ñ‹Ñ‚"
    
    await callback.message.edit_text(
        f"âœï¸ <b>Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°</b>\n\n"
        f"ğŸ“ <b>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ:</b> {product.name}\n"
        f"ğŸ’° <b>Ğ¦ĞµĞ½Ğ°:</b> {product.price}â‚¾\n"
        f"ğŸ“‹ <b>ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:</b> {product.description or 'ĞĞµÑ‚ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ'}\n"
        f"ğŸ“¦ <b>ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾:</b> {product.stock_quantity} ÑˆÑ‚.\n"
        f"ğŸ“Š <b>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:</b> {stock_status}\n\n"
        f"Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=keyboard),
        parse_mode='HTML'
    )

@router.callback_query(F.data.startswith("edit_quantity_"), admin_filter)
async def edit_product_quantity(callback: CallbackQuery, state: FSMContext):
    """Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°"""
    product_id = int(callback.data.split("_")[2])
    product = await db.get_product(product_id)
    
    if not product:
        await callback.answer(_("common.not_found", user_id=callback.from_user.id), show_alert=True)
        return
    
    await state.set_state("waiting_quantity_input")
    await state.update_data(product_id=product_id)
    
    await callback.message.edit_text(
        f"ğŸ“¦ <b>Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ°</b>\n\n"
        f"ğŸ“ <b>Ğ¢Ğ¾Ğ²Ğ°Ñ€:</b> {product.name}\n"
        f"ğŸ“Š <b>Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾:</b> {product.stock_quantity} ÑˆÑ‚.\n\n"
        f"Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ (0-999):",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data=f"edit_product_{product_id}")]
        ]),
        parse_mode='HTML'
    )

@router.callback_query(F.data.startswith("delete_product_"), admin_filter)
async def confirm_delete_product(callback: CallbackQuery):
    """ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°"""
    product_id = int(callback.data.split("_")[2])
    
    keyboard = [
        [InlineKeyboardButton(text="âœ… Ğ”Ğ°, ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ", callback_data=f"confirm_delete_{product_id}")],
        [InlineKeyboardButton(text="âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data=f"edit_product_{product_id}")]
    ]
    
    await callback.message.edit_text(
        "ğŸ—‘ <b>Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°</b>\n\n"
        "âš ï¸ Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ Ñ‚Ğ¾Ğ²Ğ°Ñ€?\n"
        "Ğ­Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ!",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=keyboard),
        parse_mode='HTML'
    )

@router.callback_query(F.data.startswith("confirm_delete_"), admin_filter)
async def delete_product(callback: CallbackQuery):
    """Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°"""
    product_id = int(callback.data.split("_")[2])
    
    await db.execute("DELETE FROM products WHERE id = $1", product_id)
    
    await callback.message.edit_text(
        "âœ… <b>Ğ¢Ğ¾Ğ²Ğ°Ñ€ ÑƒĞ´Ğ°Ğ»ĞµĞ½!</b>\n\n"
        "Ğ¢Ğ¾Ğ²Ğ°Ñ€ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½ Ğ¸Ğ· ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ°.",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="ğŸ”™ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸", callback_data="admin_products")]
        ]),
        parse_mode='HTML'
    )

@router.callback_query(F.data.startswith("toggle_stock_"), admin_filter)
async def toggle_product_stock(callback: CallbackQuery):
    """ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°"""
    product_id = int(callback.data.split("_")[2])
    product = await db.get_product(product_id)
    
    if not product:
        await callback.answer(_("common.not_found", user_id=callback.from_user.id), show_alert=True)
        return
    
    new_stock = not product.in_stock  # Ğ˜Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
    await db.update_product_stock(product_id, new_stock)
    
    status_text = "Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½ Ğ² ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğµ" if new_stock else "ÑĞºÑ€Ñ‹Ñ‚ Ğ¸Ğ· ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ°"
    
    await callback.answer(f"âœ… Ğ¢Ğ¾Ğ²Ğ°Ñ€ {status_text}!", show_alert=True)
    
    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¼ĞµĞ½Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    keyboard = [
        [InlineKeyboardButton(text="ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾Ğ²Ğ°Ñ€", callback_data=f"delete_product_{product_id}")],
        [InlineKeyboardButton(text="ğŸ“¦ Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ/ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ", callback_data=f"toggle_stock_{product_id}")],
        [InlineKeyboardButton(text="ğŸ”™ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²", callback_data="admin_edit_products")]
    ]
    
    stock_status = "âœ… Ğ’ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸" if new_stock else "âŒ Ğ¡ĞºÑ€Ñ‹Ñ‚"
    
    await callback.message.edit_text(
        f"âœï¸ <b>Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°</b>\n\n"
        f"ğŸ“ <b>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ:</b> {product.name}\n"
        f"ğŸ’° <b>Ğ¦ĞµĞ½Ğ°:</b> {product.price}â‚¾\n"
        f"ğŸ“‹ <b>ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:</b> {product.description or 'ĞĞµÑ‚ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ'}\n"
        f"ğŸ“¦ <b>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:</b> {stock_status}\n\n"
        f"Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=keyboard),
        parse_mode='HTML'
    )

@router.callback_query(F.data == "admin_add_product", admin_filter)
async def start_add_product(callback: CallbackQuery, state: FSMContext):
    """ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° - Ğ²Ñ‹Ğ±Ğ¾Ñ€ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸"""
    categories = await db.get_categories()
    
    if not categories:
        await callback.answer("âŒ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸!", show_alert=True)
        return
    
    await callback.message.edit_text(
        "â• <b>Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°</b>\n\n"
        "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°:",
        reply_markup=get_category_selection_keyboard(categories),
        parse_mode='HTML'
    )

@router.callback_query(F.data.startswith("select_category_"), admin_filter)
async def select_category_for_product(callback: CallbackQuery, state: FSMContext):
    """Ğ’Ñ‹Ğ±Ğ¾Ñ€ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°"""
    category_id = int(callback.data.split("_")[2])
    category = await db.get_category(category_id)
    
    await state.update_data(category_id=category_id)
    
    keyboard = [
        [InlineKeyboardButton(text="ğŸ”™ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸", callback_data="admin_products")]
    ]
    
    await callback.message.edit_text(
        f"â• <b>Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°</b>\n\n"
        f"ğŸ“‚ <b>ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ:</b> {category[2]} {category[1]}\n\n"
        f"ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°:",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=keyboard),
        parse_mode='HTML'
    )
    await state.set_state(AdminStates.waiting_product_name)

@router.message(AdminStates.waiting_product_name, admin_filter)
async def process_product_name(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°"""
    product_name = message.text
    await state.update_data(name=product_name)
    
    await message.answer(
        f"ğŸ“ <b>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ:</b> {product_name}\n\n"
        f"Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ÑƒĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ñ†ĞµĞ½Ñƒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° (Ğ² Ğ»Ğ°Ñ€Ğ¸):",
        parse_mode='HTML'
    )
    await state.set_state(AdminStates.waiting_product_price)

@router.message(AdminStates.waiting_product_price, admin_filter)
async def process_product_price(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ†ĞµĞ½Ñ‹ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°"""
    try:
        price = float(message.text)
        if price <= 0:
            raise ValueError
    except ValueError:
        await message.answer("âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ñ†ĞµĞ½Ñ‹. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0:")
        return
    
    data = await state.get_data()
    await state.update_data(price=price)
    
    await message.answer(
        f"ğŸ“ <b>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ:</b> {data['name']}\n"
        f"ğŸ’° <b>Ğ¦ĞµĞ½Ğ°:</b> {price}â‚¾\n\n"
        f"ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°:",
        parse_mode='HTML'
    )
    await state.set_state(AdminStates.waiting_product_description)

@router.message(AdminStates.waiting_product_description, admin_filter)
async def process_product_description(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°"""
    description = message.text
    data = await state.get_data()
    await state.update_data(description=description)
    
    await message.answer(
        f"ğŸ“ <b>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ:</b> {data['name']}\n"
        f"ğŸ’° <b>Ğ¦ĞµĞ½Ğ°:</b> {data['price']}â‚¾\n"
        f"ğŸ“‹ <b>ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:</b> {description}\n\n"
        f"ğŸ“¦ <b>Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° (1-999):</b>",
        parse_mode='HTML'
    )
    await state.set_state(AdminStates.waiting_product_quantity)

@router.message(AdminStates.waiting_product_quantity, admin_filter)
async def process_product_quantity(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°"""
    try:
        quantity = int(message.text.strip())
        if quantity < 1 or quantity > 999:
            await message.answer(
                "âŒ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ñ‚ 1 Ğ´Ğ¾ 999\n\nğŸ“¦ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°:",
                parse_mode='HTML'
            )
            return
    except ValueError:
        await message.answer(
            "âŒ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ¾Ñ‚ 1 Ğ´Ğ¾ 999\n\nğŸ“¦ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°:",
            parse_mode='HTML'
        )
        return
    
    data = await state.get_data()
    await state.update_data(stock_quantity=quantity)
    
    await message.answer(
        f"ğŸ“ <b>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ:</b> {data['name']}\n"
        f"ğŸ’° <b>Ğ¦ĞµĞ½Ğ°:</b> {data['price']}â‚¾\n"
        f"ğŸ“‹ <b>ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:</b> {data['description']}\n"
        f"ğŸ“¦ <b>ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾:</b> {quantity} ÑˆÑ‚.\n\n"
        f"Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¿Ñ€Ğ¸ÑˆĞ»Ğ¸Ñ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° (Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ 'Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ' Ğ±ĞµĞ· Ñ„Ğ¾Ñ‚Ğ¾):",
        parse_mode='HTML'
    )
    await state.set_state(AdminStates.waiting_product_photo)

@router.message(AdminStates.waiting_product_photo, F.content_type == 'photo', admin_filter)
async def process_product_photo(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ„Ğ¾Ñ‚Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°"""
    photo_file_id = message.photo[-1].file_id
    data = await state.get_data()
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ² Ğ±Ğ°Ğ·Ñƒ
    await db.add_product(
        name=data['name'],
        price=data['price'],
        description=data['description'],
        photo=photo_file_id,
        category_id=data.get('category_id'),
        stock_quantity=data.get('stock_quantity', 1)
    )
    
    await message.answer(
        f"âœ… <b>Ğ¢Ğ¾Ğ²Ğ°Ñ€ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½!</b>\n\n"
        f"ğŸ“ <b>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ:</b> {data['name']}\n"
        f"ğŸ’° <b>Ğ¦ĞµĞ½Ğ°:</b> {data['price']}â‚¾\n"
        f"ğŸ“‹ <b>ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:</b> {data['description']}\n"
        f"ğŸ“¦ <b>ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾:</b> {data.get('stock_quantity', 1)} ÑˆÑ‚.\n"
        f"ğŸ“¸ <b>Ğ¤Ğ¾Ñ‚Ğ¾:</b> Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞµÑ‰Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€", callback_data="admin_add_product")],
            [InlineKeyboardButton(text="ğŸ“¦ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸", callback_data="admin_products")],
            [InlineKeyboardButton(text="ğŸ  ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ", callback_data="admin_panel")]
        ]),
        parse_mode='HTML'
    )
    
    await state.clear()

@router.message(AdminStates.waiting_product_photo, F.text == "Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ", admin_filter)
async def process_product_no_photo(message: Message, state: FSMContext):
    """Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° Ğ±ĞµĞ· Ñ„Ğ¾Ñ‚Ğ¾"""
    data = await state.get_data()
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ² Ğ±Ğ°Ğ·Ñƒ Ğ±ĞµĞ· Ñ„Ğ¾Ñ‚Ğ¾
    await db.add_product(
        name=data['name'],
        price=data['price'],
        description=data['description'],
        photo=None,
        category_id=data.get('category_id'),
        stock_quantity=data.get('stock_quantity', 1)
    )
    
    await message.answer(
        f"âœ… <b>Ğ¢Ğ¾Ğ²Ğ°Ñ€ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½!</b>\n\n"
        f"ğŸ“ <b>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ:</b> {data['name']}\n"
        f"ğŸ’° <b>Ğ¦ĞµĞ½Ğ°:</b> {data['price']}â‚¾\n"
        f"ğŸ“‹ <b>ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:</b> {data['description']}\n"
        f"ğŸ“¦ <b>ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾:</b> {data.get('stock_quantity', 1)} ÑˆÑ‚.\n"
        f"ğŸ“¸ <b>Ğ¤Ğ¾Ñ‚Ğ¾:</b> ĞĞµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞµÑ‰Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€", callback_data="admin_add_product")],
            [InlineKeyboardButton(text="ğŸ“¦ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸", callback_data="admin_products")],
            [InlineKeyboardButton(text="ğŸ  ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ", callback_data="admin_panel")]
        ]),
        parse_mode='HTML'
    )
    
    await state.clear()

# Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ğ¼Ğ¸
@router.callback_query(F.data == "admin_all_orders", admin_filter)
async def admin_all_orders_menu(callback: CallbackQuery):
    """ĞœĞµĞ½Ñ Ğ²ÑĞµÑ… Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹"""
    await admin_all_orders_page(callback, 1)

@router.callback_query(F.data.startswith("admin_all_orders_page_"), admin_filter)
async def admin_all_orders_pagination(callback: CallbackQuery):
    """ĞŸĞ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°"""
    page = int(callback.data.split("_")[-1])
    await admin_all_orders_page(callback, page)

@router.callback_query(F.data == "admin_search_order", admin_filter)
async def admin_search_order(callback: CallbackQuery, state: FSMContext):
    """ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ¸ÑĞº Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ¿Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€Ñƒ"""
    await state.set_state("waiting_order_search")
    await callback.message.edit_text(
        "ğŸ” <b>ĞŸĞ¾Ğ¸ÑĞº Ğ·Ğ°ĞºĞ°Ğ·Ğ°</b>\n\n"
        "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ°:",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="ğŸ”™ Ğ’ÑĞµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹", callback_data="admin_all_orders")]
        ]),
        parse_mode='HTML'
    )

async def admin_all_orders_page(callback: CallbackQuery, page: int):
    """ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ²ÑĞµÑ… Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²"""
    from components.pagination import pagination
    
    orders = await db.get_all_orders()  # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹
    
    if not orders:
        text = "ğŸ“‹ <b>Ğ’ÑĞµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹</b>\n\nĞ—Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚."
        
        try:
            await callback.message.edit_text(
                text,
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="ğŸ”™ ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ", callback_data="admin_panel")]
                ]),
                parse_mode='HTML'
            )
        except Exception:
            await callback.message.delete()
            await callback.message.answer(
                text,
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="ğŸ”™ ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ", callback_data="admin_panel")]
                ]),
                parse_mode='HTML'
            )
        return

    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸ (Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¾Ğ¹ 8 ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ)
    pagination.items_per_page = 8
    pagination_info = pagination.paginate(orders, page)
    
    text = f"ğŸ“‹ <b>Ğ’ÑĞµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹</b>\n\n"
    text += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
    text += f"{_('admin.total_orders', user_id=callback.from_user.id)} <b>{len(orders)}</b>\n"
    text += pagination.get_page_info_text(pagination_info, user_id=callback.from_user.id)
    text += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
    
    # ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
    for order in pagination_info['items']:
        status_emoji = "â³" if order.status == "waiting_payment" else "ğŸ’°" if order.status == "payment_check" else "âœ…" if order.status == "paid" else "ğŸšš" if order.status == "shipping" else "ğŸ“¦" if order.status == "delivered" else "âŒ"
        text += f"{status_emoji} <b>â„–{order.order_number}</b> - {order.total_price}â‚¾\n"
        text += f"ğŸ“… {order.created_at.strftime('%d.%m %H:%M')} | ğŸ‘¤ ID:{order.user_id}\n\n"

    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹
    def order_button_generator(order, index):
        status_emoji = "â³" if order.status == "waiting_payment" else "ğŸ’°" if order.status == "payment_check" else "âœ…" if order.status == "paid" else "ğŸšš" if order.status == "shipping" else "ğŸ“¦" if order.status == "delivered" else "âŒ"
        return InlineKeyboardButton(
            text=f"{status_emoji} â„–{order.order_number} - {order.total_price}â‚¾",
            callback_data=f"admin_order_{order.id}"
        )

    additional_buttons = [
        [InlineKeyboardButton(text="ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€Ñƒ", callback_data="admin_search_order")],
        [InlineKeyboardButton(text="ğŸ”™ ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ", callback_data="admin_panel")]
    ]

    keyboard = pagination.create_pagination_keyboard(
        pagination_info=pagination_info,
        callback_prefix="admin_all_orders_page",
        user_id=callback.from_user.id,
        item_button_generator=order_button_generator,
        additional_buttons=additional_buttons
    )
    
    try:
        await callback.message.edit_text(
            text,
            reply_markup=keyboard,
            parse_mode='HTML'
        )
    except Exception:
        await callback.message.delete()
        await callback.message.answer(
            text,
            reply_markup=keyboard,
            parse_mode='HTML'
        )

# ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² (Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ ĞŸĞ•Ğ Ğ•Ğ” Ğ¾Ğ±Ñ‰Ğ¸Ğ¼ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ¼)
@router.message(AdminStates.waiting_client_message)
async def process_client_message_early(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ"""
    print("DEBUG: process_client_message_early called!")  # Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğµ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    data = await state.get_data()
    client_id = data.get('client_id')
    order_number = data.get('order_number')
    order_id = data.get('order_id')
    
    if not client_id:
        admin_language = 'ru'  # Ğ¯Ğ·Ñ‹Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
        await message.answer(_("error.client_id_not_found", admin_language))
        await state.clear()
        return
    
    # Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ½Ğ° ĞµĞ³Ğ¾ ÑĞ·Ñ‹ĞºĞµ
    client_message = (
        f"{_('admin_message.header', user_id=client_id)}\n"
        f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        f"{_('admin_message.order_prefix', user_id=client_id)}{order_number}\n\n"
        f"{message.text}\n\n"
        f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        f"<i>{_('admin_message.footer', user_id=client_id)}</i>"
    )
    
    try:
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ
        await message.bot.send_message(
            client_id,
            client_message,
            parse_mode='HTML'
        )
        
        # ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ
        admin_language = 'ru'  # Ğ¯Ğ·Ñ‹Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
        await message.answer(
            _("admin.message_sent_success", admin_language).format(
                client_id=client_id,
                order_number=order_number
            ),
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text=_("common.to_orders", admin_language), callback_data=f"admin_order_{order_id}")],
                [InlineKeyboardButton(text=_("common.to_admin", admin_language), callback_data="admin_panel")]
            ]),
            parse_mode='HTML'
        )
    except Exception as e:
        admin_language = 'ru'  # Ğ¯Ğ·Ñ‹Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
        await message.answer(
            _("admin.message_send_error", admin_language).format(error=str(e)),
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text=_("common.to_orders", admin_language), callback_data=f"admin_order_{order_id}")],
                [InlineKeyboardButton(text=_("common.to_admin", admin_language), callback_data="admin_panel")]
            ]),
            parse_mode='HTML'
        )
    
    await state.clear()

# Ğ¡Ğ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹ - Ğ”ĞĞ›Ğ–ĞĞ« Ğ‘Ğ«Ğ¢Ğ¬ Ğ’Ğ«Ğ¨Ğ• ĞĞ‘Ğ©Ğ•Ğ“Ğ ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ
@router.message(AdminStates.waiting_client_id)
async def process_client_id_input(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ²Ğ²Ğ¾Ğ´ ID ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°"""
    admin_language = 'ru'  # Ğ¯Ğ·Ñ‹Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
    
    try:
        client_id = int(message.text.strip())
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ
        user = await db.get_user(client_id)
        if not user:
            await message.answer(
                _("admin.client_not_found", admin_language).format(client_id=client_id),
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text=_("common.to_admin", admin_language), callback_data="admin_panel")]
                ]),
                parse_mode='HTML'
            )
            await state.clear()
            return
        
        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ID ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ² ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸
        await state.update_data(
            client_id=client_id,
            client_name=user.first_name,
            client_username=user.username
        )
        await state.set_state(AdminStates.waiting_general_client_message)
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ·Ñ‹Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        from i18n import i18n
        user_language = i18n.get_user_language(client_id)
        language_names = {'ru': 'Ğ ÑƒÑÑĞºĞ¸Ğ¹', 'ka': 'áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜', 'en': 'English'}
        
        await message.answer(
            _("admin.general_message_client_form", admin_language).format(
                client_id=client_id,
                client_name=user.first_name,
                client_username=f"@{user.username}" if user.username else "Ğ½ĞµÑ‚",
                user_language=language_names.get(user_language, user_language)
            ),
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text=_("common.cancel", admin_language), callback_data="admin_panel")]
            ]),
            parse_mode='HTML'
        )
        
    except ValueError:
        await message.answer(
            _("admin.invalid_client_id", admin_language),
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text=_("common.to_admin", admin_language), callback_data="admin_panel")]
            ]),
            parse_mode='HTML'
        )
        await state.clear()

@router.message(AdminStates.waiting_general_client_message)
async def process_general_client_message(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ñ‰ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ"""
    admin_language = 'ru'  # Ğ¯Ğ·Ñ‹Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
    data = await state.get_data()
    client_id = data.get('client_id')
    client_name = data.get('client_name')
    
    if not client_id:
        await message.answer(_("error.client_id_not_found", admin_language))
        await state.clear()
        return
    
    # Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ½Ğ° ĞµĞ³Ğ¾ ÑĞ·Ñ‹ĞºĞµ
    client_message = (
        f"{_('admin_message.header', user_id=client_id)}\n"
        f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        f"{message.text}\n\n"
        f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        f"<i>{_('admin_message.footer', user_id=client_id)}</i>"
    )
    
    try:
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ
        await message.bot.send_message(
            client_id,
            client_message,
            parse_mode='HTML'
        )
        
        # ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ
        await message.answer(
            _("admin.general_message_sent_success", admin_language).format(
                client_id=client_id,
                client_name=client_name
            ),
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text=_("admin.message_client", admin_language), callback_data="admin_message_client")],
                [InlineKeyboardButton(text=_("common.to_admin", admin_language), callback_data="admin_panel")]
            ]),
            parse_mode='HTML'
        )
    except Exception as e:
        await message.answer(
            _("admin.general_message_send_error", admin_language).format(
                client_name=client_name,
                error=str(e)
            ),
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text=_("admin.message_client", admin_language), callback_data="admin_message_client")],
                [InlineKeyboardButton(text=_("common.to_admin", admin_language), callback_data="admin_panel")]
            ]),
            parse_mode='HTML'
        )
    
    await state.clear()

@router.message(F.text, lambda message: message.from_user.id in ADMIN_IDS)
async def process_admin_message(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¾Ñ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ"""
    current_state = await state.get_state()
    print(f"DEBUG: Current state = {current_state}")  # Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğµ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    
    if current_state == "waiting_order_search":
        await process_order_search(message, state)
    elif current_state == "waiting_quantity_input":
        await process_quantity_input(message, state)
    elif current_state in ["AdminManagementStates:waiting_admin_id", "AdminStates:waiting_admin_id", "AdminStates:waiting_client_message", "AdminStates:waiting_client_id", "AdminStates:waiting_general_client_message"]:
        # ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ - Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡Ğ½Ñ‹Ğ¼Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ°Ğ¼Ğ¸
        return
    else:
        # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ² ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ¸ÑĞºĞ°, ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        await message.delete()

async def process_quantity_input(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ²Ğ²Ğ¾Ğ´Ğ° ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°"""
    try:
        await message.delete()
        
        quantity_text = message.text.strip()
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ²Ğ²ĞµĞ´ĞµĞ½Ğ¾ Ñ‡Ğ¸ÑĞ»Ğ¾
        if not quantity_text.isdigit():
            await message.bot.send_message(
                chat_id=message.chat.id,
                text="âŒ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼ Ğ¾Ñ‚ 0 Ğ´Ğ¾ 999\n\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾:",
                parse_mode='HTML'
            )
            return
        
        quantity = int(quantity_text)
        if quantity < 0 or quantity > 999:
            await message.bot.send_message(
                chat_id=message.chat.id,
                text="âŒ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ñ‚ 0 Ğ´Ğ¾ 999\n\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾:",
                parse_mode='HTML'
            )
            return
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ product_id Ğ¸Ğ· ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
        data = await state.get_data()
        product_id = data.get('product_id')
        
        if not product_id:
            await state.clear()
            await message.bot.send_message(
                chat_id=message.chat.id,
                text="âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½",
                parse_mode='HTML'
            )
            return
        
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
        await db.execute("UPDATE products SET stock_quantity = $1 WHERE id = $2", quantity, product_id)
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğµ
        product = await db.get_product(product_id)
        
        await state.clear()
        
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ÑÑ Ğº Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°
        await message.bot.send_message(
            chat_id=message.chat.id,
            text=f"âœ… ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾!\n\n"
                 f"ğŸ“ <b>Ğ¢Ğ¾Ğ²Ğ°Ñ€:</b> {product.name}\n"
                 f"ğŸ“¦ <b>ĞĞ¾Ğ²Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾:</b> {quantity} ÑˆÑ‚.",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="ğŸ”™ Ğš Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ", callback_data=f"edit_product_{product_id}")],
                [InlineKeyboardButton(text="ğŸ“‹ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²", callback_data="admin_edit_products")]
            ]),
            parse_mode='HTML'
        )
        
    except Exception as e:
        await state.clear()
        await message.bot.send_message(
            chat_id=message.chat.id,
            text=f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ°: {str(e)}",
            parse_mode='HTML'
        )

async def process_order_search(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ¿Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€Ñƒ"""
    order_number = message.text.strip()
    
    try:
        
        # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        await message.delete()
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ²Ğ²ĞµĞ´ĞµĞ½Ğ¾ Ñ‡Ğ¸ÑĞ»Ğ¾
        if not order_number.isdigit():
            await message.bot.send_message(
                chat_id=message.chat.id,
                text="ğŸ” <b>ĞÑˆĞ¸Ğ±ĞºĞ°</b>\n\nâŒ ĞĞ¾Ğ¼ĞµÑ€ Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ†Ğ¸Ñ„Ñ€Ñ‹\n\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ·Ğ°ĞºĞ°Ğ·Ğ°:",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="ğŸ”™ Ğ’ÑĞµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹", callback_data="admin_all_orders")]
                ]),
                parse_mode='HTML'
            )
            return
        
        # ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ² int Ğ¸ Ğ¸Ñ‰ĞµĞ¼ Ğ·Ğ°ĞºĞ°Ğ· Ğ¿Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€Ñƒ
        order_number_int = int(order_number)
        order = await db.get_order_by_number(order_number_int)
        
        if not order:
            # Ğ—Ğ°ĞºĞ°Ğ· Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½
            text = f"ğŸ” <b>Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¿Ğ¾Ğ¸ÑĞºĞ°</b>\n\n"
            text += f"âŒ Ğ—Ğ°ĞºĞ°Ğ· â„–{order_number} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½\n\n"
            text += f"ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ·Ğ°ĞºĞ°Ğ·Ğ°:"
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="ğŸ”™ Ğ’ÑĞµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹", callback_data="admin_all_orders")]
            ])
        else:
            # Ğ—Ğ°ĞºĞ°Ğ· Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ - Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸
            await state.clear()
            
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ°  
            order_items = await db.get_order_items(order.id)
            
            status_emoji = "â³" if order.status == "waiting_payment" else "ğŸ’°" if order.status == "payment_check" else "âœ…" if order.status == "paid" else "ğŸšš" if order.status == "shipping" else "ğŸ“¦" if order.status == "delivered" else "âŒ"
            
            text = f"ğŸ” <b>ĞĞ°Ğ¹Ğ´ĞµĞ½ Ğ·Ğ°ĞºĞ°Ğ·</b>\n\n"
            text += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            text += f"{status_emoji} <b>Ğ—Ğ°ĞºĞ°Ğ· â„–{order.order_number}</b>\n"
            text += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            text += f"ğŸ‘¤ <b>ĞšĞ»Ğ¸ĞµĞ½Ñ‚ ID:</b> {order.user_id}\n"
            text += f"ğŸ“… <b>Ğ”Ğ°Ñ‚Ğ°:</b> {order.created_at.strftime('%d.%m.%Y %H:%M')}\n"
            text += f"ğŸ“Š <b>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:</b> {order.status}\n"
            text += f"ğŸ’° <b>Ğ¡ÑƒĞ¼Ğ¼Ğ°:</b> {order.total_price}â‚¾\n\n"
            
            if order.phone:
                text += f"ğŸ“ <b>ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚:</b> {order.phone}\n"
            if order.address:
                text += f"ğŸ“ <b>ĞĞ´Ñ€ĞµÑ:</b> {order.address}\n"
            
            text += f"\n<b>ğŸ“¦ Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹:</b>\n"
            for item in order_items:
                text += f"â€¢ {item.product_name} Ã— {item.quantity} = {item.price * item.quantity}â‚¾\n"
            
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="ğŸ”§ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ¼", callback_data=f"admin_order_{order.id}")],
                [InlineKeyboardButton(text="ğŸ”™ Ğ’ÑĞµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹", callback_data="admin_all_orders")]
            ])
        
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ (Ğ¿Ñ€Ğ¾Ñ‰Ğµ Ğ¸ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½ĞµĞµ)
        await message.bot.send_message(
            chat_id=message.chat.id,
            text=text,
            reply_markup=keyboard,
            parse_mode='HTML'
        )
        
        if not order:
            # Ğ•ÑĞ»Ğ¸ Ğ·Ğ°ĞºĞ°Ğ· Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½, Ğ¾ÑÑ‚Ğ°ĞµĞ¼ÑÑ Ğ² ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ¸ÑĞºĞ°
            return
            
    except Exception as e:
        import traceback
        print(f"âŒ ĞŸĞĞ›ĞĞĞ¯ ĞĞ¨Ğ˜Ğ‘ĞšĞ: {traceback.format_exc()}")  # Ğ”Ğ»Ñ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ Ğ³Ğ´Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°
        await state.clear()
        await message.bot.send_message(
            chat_id=message.chat.id,
            text=f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¸ÑĞºĞµ Ğ·Ğ°ĞºĞ°Ğ·Ğ°: {str(e)}\n\nĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·.",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="ğŸ”™ Ğ’ÑĞµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹", callback_data="admin_all_orders")]
            ]),
            parse_mode='HTML'
        )

# Ğ¡Ğ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ±Ñ‹Ñ‚ÑŒ ĞŸĞ•Ğ Ğ•Ğ” Ğ¾Ğ±Ñ‰Ğ¸Ğ¼ admin_order_
@router.callback_query(F.data.startswith("admin_reject_payment_"), admin_filter)
async def reject_payment(callback: CallbackQuery, state: FSMContext):
    """ĞÑ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ñ‚ÑŒ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñƒ Ğ·Ğ°ĞºĞ°Ğ·Ğ° - Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹"""
    print(f"DEBUG: reject_payment Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ½ Ñ callback_data: {callback.data}")
    order_id = int(callback.data.split("_")[3])
    print(f"DEBUG: Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½ order_id: {order_id}")
    order = await db.get_order(order_id)
    
    if not order:
        await callback.answer(_("admin.order_not_found", user_id=callback.from_user.id), show_alert=True)
        return
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ·Ñ‹Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    user = await db.get_user(order.user_id)
    user_lang = 'ru'  # ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ñ€ÑƒÑÑĞºĞ¸Ğ¹
    if user:
        # Ğ—Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞ·Ñ‹Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ· Ğ‘Ğ” Ğ¸Ğ»Ğ¸ i18n
        from i18n import i18n
        user_lang = i18n.get_user_language(order.user_id) or 'ru'
    
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ² ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
    await state.update_data(
        order_id=order_id, 
        order_number=order.order_number, 
        user_id=order.user_id,
        total_price=order.total_price,
        user_lang=user_lang
    )
    
    # Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñƒ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ñ
    from i18n import _
    lang_names = {'ru': 'ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹', 'en': 'ğŸ‡ºğŸ‡¸ English', 'ka': 'ğŸ‡¬ğŸ‡ª áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜'}
    
    text = _("admin.rejection_form", user_id=callback.from_user.id, 
             order_number=order.order_number, 
             total_price=order.total_price,
             user_language=lang_names.get(user_lang, user_lang))
    
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data=f"admin_order_{order_id}")]
    ])
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´
    if callback.message.photo:
        await callback.message.edit_caption(caption=text, reply_markup=keyboard, parse_mode='HTML')
    else:
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode='HTML')
    
    await state.set_state(AdminStates.waiting_rejection_reason)

@router.callback_query(F.data.startswith("admin_order_"), admin_filter)
async def show_admin_order(callback: CallbackQuery):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°"""
    # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ callback_data Ğ¸ Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ order_id
    parts = callback.data.split("_")
    if parts[0] == "admin" and parts[1] == "order":
        order_id = int(parts[2])  # admin_order_X
    elif len(parts) >= 3:
        order_id = int(parts[-1])  # admin_confirm_payment_X, admin_ship_X, etc.
    else:
        await callback.answer("âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ½ĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…", show_alert=True)
        return
    order = await db.get_order(order_id)
    
    if not order:
        await callback.answer("âŒ Ğ—Ğ°ĞºĞ°Ğ· Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", show_alert=True)
        return
    
    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¾Ğ²
    products = order.products_data
    user = await db.get_user(order.user_id)
    
    status_text = {
        'waiting_payment': 'â³ ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹',
        'payment_check': 'ğŸ’° ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹',
        'paid': 'âœ… ĞĞ¿Ğ»Ğ°Ñ‡ĞµĞ½, Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ñ‚ÑÑ Ğº Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ',
        'shipping': 'ğŸšš ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½',
        'delivered': 'âœ… Ğ”Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½',
        'cancelled': 'âŒ ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½'
    }
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ·Ñ‹Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    from i18n import i18n
    user_language = i18n.get_user_language(order.user_id)
    language_names = {'ru': 'Ğ ÑƒÑÑĞºĞ¸Ğ¹', 'ka': 'áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜', 'en': 'English'}
    
    order_text = f"""ğŸ“‹ <b>Ğ—Ğ°ĞºĞ°Ğ· #{order.order_number}</b>

ğŸ‘¤ <b>ĞšĞ»Ğ¸ĞµĞ½Ñ‚:</b>
â€¢ Ğ˜Ğ¼Ñ: {user.first_name if user else 'ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾'}
â€¢ Username: @{user.username if user and user.username else 'Ğ½ĞµÑ‚'}
â€¢ ID: {order.user_id}
â€¢ ğŸŒ Ğ¯Ğ·Ñ‹Ğº: {language_names.get(user_language, user_language)}

ğŸ“¦ <b>Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹:</b>
"""
    
    for product in products:
        order_text += f"â€¢ {product['name']} Ã— {product['quantity']} = {product['price'] * product['quantity']}â‚¾\n"
    
    zone_info = DELIVERY_ZONES.get(order.delivery_zone, {'name': 'ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾'})
    
    order_text += f"""
ğŸšš <b>Ğ”Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ°:</b> {zone_info['name']} - {order.delivery_price}â‚¾
ğŸ“ <b>ĞĞ´Ñ€ĞµÑ:</b> {order.address}
ğŸ“± <b>Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½:</b> {order.phone}
ğŸ“… <b>Ğ”Ğ°Ñ‚Ğ°:</b> {str(order.created_at)[:16]}

ğŸ’° <b>Ğ˜Ñ‚Ğ¾Ğ³Ğ¾: {order.total_price}â‚¾</b>

ğŸ“Š <b>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:</b> {status_text.get(order.status, order.status)}"""
    
    # Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹, Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ĞµĞ³Ğ¾
    if order.payment_screenshot:
        try:
            await callback.message.delete()
            await callback.message.answer_photo(
                photo=order.payment_screenshot,
                caption=order_text,
                reply_markup=get_admin_order_actions_keyboard(order_id, order.status),
                parse_mode='HTML'
            )
        except:
            await callback.message.edit_text(
                order_text + "\n\nğŸ“¸ Ğ¡ĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ¿Ñ€Ğ¸ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½",
                reply_markup=get_admin_order_actions_keyboard(order_id, order.status),
                parse_mode='HTML'
            )
    else:
        await callback.message.edit_text(
            order_text,
            reply_markup=get_admin_order_actions_keyboard(order_id, order.status),
            parse_mode='HTML'
        )

# Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ğ¼Ğ¸
@router.callback_query(F.data.startswith("admin_confirm_payment_"), admin_filter)
async def confirm_payment(callback: CallbackQuery):
    """ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñƒ Ğ·Ğ°ĞºĞ°Ğ·Ğ°"""
    order_id = int(callback.data.split("_")[3])
    order = await db.get_order(order_id)
    
    if not order:
        await callback.answer("âŒ Ğ—Ğ°ĞºĞ°Ğ· Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", show_alert=True)
        return
    
    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
    await db.update_order_status(order_id, 'paid')
    
    # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
    try:
        await callback.message.bot.send_message(
            order.user_id,
            f"âœ… <b>ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ°!</b>\n\n"
            f"Ğ—Ğ°ĞºĞ°Ğ· #{order.order_number} Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ Ğ² Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ.\n"
            f"Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ğ¼ Ğ²Ğ°Ñˆ Ğ·Ğ°ĞºĞ°Ğ· Ğº Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ! ğŸ“¦",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="ğŸ”™ Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ", callback_data="back_to_menu")]
            ]),
            parse_mode='HTML'
        )
    except:
        pass
    
    await callback.answer("âœ… ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ°!")
    
    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ
    await show_admin_order(callback)

@router.message(AdminStates.waiting_rejection_reason, admin_filter)
async def process_rejection_reason(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°"""
    reason = message.text
    data = await state.get_data()
    
    order_id = data.get('order_id')
    order_number = data.get('order_number')
    user_id = data.get('user_id')
    total_price = data.get('total_price')
    user_lang = data.get('user_lang', 'ru')
    
    if not order_id:
        await message.answer(_("admin.rejection_data_error", user_id=message.from_user.id))
        await state.clear()
        return
    
    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ·Ğ°ĞºĞ°Ğ·Ğ°
    await db.update_order_status(order_id, 'waiting_payment')
    
    # Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ°
    from i18n import _
    
    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ñ‹ Ğ´Ğ»Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    message_text = _("admin.payment_rejected", user_id=user_id, 
                    order_number=order_number, 
                    total_price=total_price,
                    reason=reason)
    
    resend_text = _("admin.resend_screenshot", user_id=user_id)
    contact_text = _("admin.contact_support", user_id=user_id)
    menu_text = _("common.main_menu", user_id=user_id)
    
    # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ñ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ¾Ğ¹ Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸
    try:
        await message.bot.send_message(
            user_id,
            message_text,
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text=resend_text, callback_data=f"resend_screenshot_{order_number}")],
                [InlineKeyboardButton(text=contact_text, callback_data="contact")],
                [InlineKeyboardButton(text=menu_text, callback_data="back_to_menu")]
            ]),
            parse_mode='HTML'
        )
        await message.answer(_("admin.rejection_success", user_id=message.from_user.id))
    except Exception as e:
        await message.answer(_("admin.rejection_error", user_id=message.from_user.id, error=str(e)))
    
    # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
    await state.clear()
    
    # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²
    await message.answer(
        "ğŸ“‹ <b>Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ğ¼Ğ¸</b>",
        reply_markup=get_admin_orders_keyboard(),
        parse_mode='HTML'
    )

@router.callback_query(F.data.startswith("admin_ship_"), admin_filter)
async def ship_order(callback: CallbackQuery):
    """ĞÑ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ· ĞºĞ°Ğº Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹"""
    order_id = int(callback.data.split("_")[2])
    order = await db.get_order(order_id)
    
    if not order:
        await callback.answer("âŒ Ğ—Ğ°ĞºĞ°Ğ· Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", show_alert=True)
        return
    
    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
    await db.update_order_status(order_id, 'shipping')
    
    # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
    try:
        await callback.message.bot.send_message(
            order.user_id,
            f"ğŸšš <b>Ğ—Ğ°ĞºĞ°Ğ· Ğ² Ğ¿ÑƒÑ‚Ğ¸!</b>\n\n"
            f"Ğ—Ğ°ĞºĞ°Ğ· #{order.order_number} Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ Ğ¿Ğ¾ Ğ°Ğ´Ñ€ĞµÑÑƒ:\n"
            f"{order.address}\n\n"
            f"ĞĞ¶Ğ¸Ğ´Ğ°Ğ¹Ñ‚Ğµ ĞºÑƒÑ€ÑŒĞµÑ€Ğ°! ğŸ“¦",
            parse_mode='HTML'
        )
    except:
        pass
    
    await callback.answer("ğŸšš Ğ—Ğ°ĞºĞ°Ğ· Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½!")
    
    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ
    await show_admin_order(callback)

@router.callback_query(F.data.startswith("admin_deliver_"), admin_filter)
async def deliver_order(callback: CallbackQuery):
    """ĞÑ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ· ĞºĞ°Ğº Ğ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹"""
    order_id = int(callback.data.split("_")[2])
    order = await db.get_order(order_id)
    
    if not order:
        await callback.answer("âŒ Ğ—Ğ°ĞºĞ°Ğ· Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", show_alert=True)
        return
    
    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
    await db.update_order_status(order_id, 'delivered')
    
    # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
    try:
        await callback.message.bot.send_message(
            order.user_id,
            f"âœ… <b>Ğ—Ğ°ĞºĞ°Ğ· Ğ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½!</b>\n\n"
            f"Ğ—Ğ°ĞºĞ°Ğ· #{order.order_number} ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½.\n"
            f"Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾ Ğ·Ğ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºÑƒ! ğŸ™\n\n"
            f"ĞÑ†ĞµĞ½Ğ¸Ñ‚Ğµ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ğ±ÑĞ»ÑƒĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸ Ğ¿Ğ¾Ğ´ĞµĞ»Ğ¸Ñ‚ĞµÑÑŒ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ¼!",
            parse_mode='HTML'
        )
    except:
        pass
    
    await callback.answer("âœ… Ğ—Ğ°ĞºĞ°Ğ· Ğ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½!")
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ÑÑ Ğº ÑĞ¿Ğ¸ÑĞºÑƒ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²
    await admin_orders_menu(callback)

@router.callback_query(F.data.startswith("admin_cancel_"), admin_filter)
async def cancel_order(callback: CallbackQuery):
    """ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ·"""
    order_id = int(callback.data.split("_")[2])
    order = await db.get_order(order_id)
    
    if not order:
        await callback.answer("âŒ Ğ—Ğ°ĞºĞ°Ğ· Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", show_alert=True)
        return
    
    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
    await db.update_order_status(order_id, 'cancelled')
    
    # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
    try:
        await callback.message.bot.send_message(
            order.user_id,
            f"âŒ <b>Ğ—Ğ°ĞºĞ°Ğ· Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½</b>\n\n"
            f"Ğ—Ğ°ĞºĞ°Ğ· #{order.order_number} Ğ±Ñ‹Ğ» Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼.\n"
            f"Ğ•ÑĞ»Ğ¸ Ñƒ Ğ²Ğ°Ñ ĞµÑÑ‚ÑŒ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹, Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğ² Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ.",
            parse_mode='HTML'
        )
    except:
        pass
    
    await callback.answer("âŒ Ğ—Ğ°ĞºĞ°Ğ· Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½!")
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ÑÑ Ğº ÑĞ¿Ğ¸ÑĞºÑƒ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²
    await admin_orders_menu(callback)

# Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°
@router.callback_query(F.data == "admin_stats", admin_filter)
async def show_stats(callback: CallbackQuery):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ"""
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸
    all_orders = await db.fetchall("SELECT status FROM orders")
    users_count = (await db.fetchone("SELECT COUNT(*) FROM users"))[0]
    products_count = (await db.fetchone("SELECT COUNT(*) FROM products WHERE in_stock = true"))[0]
    
    # ĞŸĞ¾Ğ´ÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼
    status_counts = {
        'waiting_payment': 0,
        'payment_check': 0,
        'paid': 0,
        'shipping': 0,
        'delivered': 0,
        'cancelled': 0
    }
    
    for order in all_orders:
        status = order[0]
        if status in status_counts:
            status_counts[status] += 1
    
    # Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ´Ğ¾Ñ…Ğ¾Ğ´Ñ‹
    delivered_orders = await db.fetchall("SELECT total_price FROM orders WHERE status = 'delivered'")
    total_revenue = sum(order[0] for order in delivered_orders)
    
    stats_text = f"""ğŸ“Š <b>Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ°</b>

ğŸ‘¥ <b>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸:</b> {users_count}
ğŸ“¦ <b>Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ² Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸:</b> {products_count}

ğŸ“‹ <b>Ğ—Ğ°ĞºĞ°Ğ·Ñ‹:</b>
â³ ĞĞ¶Ğ¸Ğ´Ğ°ÑÑ‚ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹: {status_counts['waiting_payment']}
ğŸ’° ĞĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ: {status_counts['payment_check']}
âœ… ĞĞ¿Ğ»Ğ°Ñ‡ĞµĞ½Ñ‹: {status_counts['paid']}
ğŸšš ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹: {status_counts['shipping']}
âœ… Ğ”Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ñ‹: {status_counts['delivered']}
âŒ ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½Ñ‹: {status_counts['cancelled']}

ğŸ’° <b>Ğ”Ğ¾Ñ…Ğ¾Ğ´Ñ‹:</b>
Ğ’ÑĞµĞ³Ğ¾ Ğ·Ğ°Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾: {total_revenue:.2f}â‚¾"""

    await callback.message.edit_text(
        stats_text,
        reply_markup=get_admin_keyboard(),
        parse_mode='HTML'
    )

# Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ°
@router.callback_query(F.data == "admin_broadcast", admin_filter)
async def start_broadcast(callback: CallbackQuery, state: FSMContext):
    """ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºÑƒ"""
    keyboard = [
        [InlineKeyboardButton(text="ğŸ”™ ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ", callback_data="admin_panel")]
    ]
    
    await callback.message.edit_text(
        "ğŸ“¢ <b>Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹</b>\n\n"
        "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸ Ğ²ÑĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼:",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=keyboard),
        parse_mode='HTML'
    )
    await state.set_state(AdminStates.waiting_broadcast_message)

@router.message(AdminStates.waiting_broadcast_message, admin_filter)
async def process_broadcast(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸"""
    broadcast_text = message.text
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    users = await db.fetchall("SELECT user_id FROM users")
    
    sent = 0
    failed = 0
    
    status_msg = await message.answer("ğŸ“¢ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹...")
    
    for user in users:
        try:
            await message.bot.send_message(user[0], broadcast_text)
            sent += 1
        except:
            failed += 1
    
    await status_msg.edit_text(
        f"âœ… <b>Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!</b>\n\n"
        f"ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾: {sent}\n"
        f"âŒ ĞĞµ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¾: {failed}",
        parse_mode='HTML'
    )
    
    await state.clear()

# ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼Ğ¸
@router.callback_query(F.data == "admin_categories", admin_filter)
async def show_admin_categories(callback: CallbackQuery):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼Ğ¸"""
    await callback.message.edit_text(
        "ğŸ·ï¸ <b>Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼Ğ¸</b>\n\n"
        "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:",
        reply_markup=get_admin_categories_keyboard(),
        parse_mode='HTML'
    )

@router.callback_query(F.data == "admin_add_category", admin_filter)
async def start_add_category(callback: CallbackQuery, state: FSMContext):
    """ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸"""
    keyboard = [
        [InlineKeyboardButton(text="ğŸ”™ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼Ğ¸", callback_data="admin_categories")]
    ]
    
    await callback.message.edit_text(
        "â• <b>Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸</b>\n\n"
        "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸:",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=keyboard),
        parse_mode='HTML'
    )
    await state.set_state(AdminStates.waiting_category_name)

@router.message(AdminStates.waiting_category_name, admin_filter)
async def process_category_name(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸"""
    category_name = message.text
    await state.update_data(name=category_name)
    
    keyboard = [
        [InlineKeyboardButton(text="ğŸ”™ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼Ğ¸", callback_data="admin_categories")]
    ]
    
    await message.answer(
        f"â• <b>Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸</b>\n\n"
        f"ğŸ“ <b>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ:</b> {category_name}\n\n"
        f"ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ´Ğ»Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: ğŸ§š, ğŸ’¨, ğŸ”¥):",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=keyboard),
        parse_mode='HTML'
    )
    await state.set_state(AdminStates.waiting_category_emoji)

@router.message(AdminStates.waiting_category_emoji, admin_filter)
async def process_category_emoji(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸"""
    emoji = message.text
    await state.update_data(emoji=emoji)
    
    keyboard = [
        [InlineKeyboardButton(text="ğŸ”™ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼Ğ¸", callback_data="admin_categories")]
    ]
    
    await message.answer(
        f"â• <b>Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸</b>\n\n"
        f"ğŸ“ <b>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ:</b> {emoji} {message.text}\n\n"
        f"ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ (Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ 'Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ'):",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=keyboard),
        parse_mode='HTML'
    )
    await state.set_state(AdminStates.waiting_category_description)

@router.message(AdminStates.waiting_category_description, admin_filter)
async def process_category_description(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸"""
    data = await state.get_data()
    description = message.text if message.text != "Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ" else None
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ Ğ² Ğ±Ğ°Ğ·Ñƒ
    await db.add_category(
        name=data['name'],
        emoji=data['emoji'],
        description=description
    )
    
    await message.answer(
        f"âœ… <b>ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ°!</b>\n\n"
        f"ğŸ“ <b>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ:</b> {data['emoji']} {data['name']}\n"
        f"ğŸ“„ <b>ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:</b> {description or 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾'}",
        reply_markup=get_admin_categories_keyboard(),
        parse_mode='HTML'
    )
    
    await state.clear()

# ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼Ğ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²
@router.callback_query(F.data.startswith("admin_change_status_"), admin_filter)
async def change_order_status_menu(callback: CallbackQuery):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¼ĞµĞ½Ñ ÑĞ¼ĞµĞ½Ñ‹ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ·Ğ°ĞºĞ°Ğ·Ğ°"""
    order_id = int(callback.data.split("_")[-1])
    
    await callback.message.edit_text(
        f"ğŸ”„ <b>Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ·Ğ°ĞºĞ°Ğ·Ğ° #{order_id}</b>\n\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ:",
        reply_markup=get_change_status_keyboard(order_id, user_id=callback.from_user.id),
        parse_mode="HTML"
    )

@router.callback_query(F.data.startswith("set_status_"), admin_filter)  
async def set_order_status(callback: CallbackQuery):
    """Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ·Ğ°ĞºĞ°Ğ·Ğ°"""
    parts = callback.data.split("_")
    new_status = "_".join(parts[2:-1])  # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¼ĞµĞ¶Ğ´Ñƒ "set_status_" Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ¼ Ğ·Ğ°ĞºĞ°Ğ·Ğ°
    order_id = int(parts[-1])
    
    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
    await db.update_order_status(order_id, new_status)
    
    status_names = {
        "waiting_payment": "Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµÑ‚ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹",
        "payment_check": "Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹", 
        "paid": "Ğ¾Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½",
        "shipping": "Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½",
        "delivered": "Ğ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½",
        "cancelled": "Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½"
    }
    
    await callback.answer(f"âœ… Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½ Ğ½Ğ° \"{status_names.get(new_status, new_status)}\"")
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ÑÑ Ğº Ğ·Ğ°ĞºĞ°Ğ·Ñƒ
    await show_admin_order(callback)



# ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ¿Ğ°Ğ¼Ğ¾Ğ¼ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)
@router.message(F.text == "/antispam", admin_filter)
async def show_antispam_menu(message: Message):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¼ĞµĞ½Ñ Ğ°Ğ½Ñ‚Ğ¸-ÑĞ¿Ğ°Ğ¼ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹"""
    blocked_count = len(anti_spam.get_blocked_users())
    total_users = len(anti_spam.user_stats)
    
    text = f"""ğŸ›¡ <b>ĞĞ½Ñ‚Ğ¸-ÑĞ¿Ğ°Ğ¼ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°</b>

ğŸ“Š <b>Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:</b>
â€¢ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: {total_users}
â€¢ Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ…: {blocked_count}

âš™ï¸ <b>ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸:</b>
â€¢ ĞœĞ°ĞºÑ. ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹/Ğ¼Ğ¸Ğ½: {anti_spam.MAX_MESSAGES_PER_MINUTE}
â€¢ ĞœĞ°ĞºÑ. ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹/Ñ‡Ğ°Ñ: {anti_spam.MAX_MESSAGES_PER_HOUR}
â€¢ ĞœĞ¸Ğ½. Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»: {anti_spam.MIN_MESSAGE_INTERVAL}Ñ
â€¢ ĞŸĞ¾Ñ€Ğ¾Ğ³ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸: {anti_spam.SPAM_THRESHOLD}

<b>ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:</b>
/blocked - ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ…
/unblock [ID] - Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
/stats [ID] - ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
/block [ID] - Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""

    await message.answer(text, parse_mode="HTML")

@router.message(F.text == "/blocked", admin_filter)
async def show_blocked_users(message: Message):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹"""
    blocked = anti_spam.get_blocked_users()
    
    if not blocked:
        await message.answer("âœ… Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ½ĞµÑ‚.")
        return
    
    text = "ğŸš« <b>Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸:</b>\n\n"
    
    for user in blocked[:10]:  # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 10
        user_id = user["user_id"]
        spam_score = user["spam_score"]
        warnings = user["warning_count"]
        
        if user["permanent"]:
            status = "ĞĞ°Ğ²ÑĞµĞ³Ğ´Ğ°"
        else:
            remaining = user["remaining_time"]
            status = f"{remaining}Ñ" if remaining > 0 else "Ğ˜ÑÑ‚ĞµĞºĞ°ĞµÑ‚"
        
        text += f"â€¢ ID: {user_id}\n"
        text += f"  Ğ¡Ğ¿Ğ°Ğ¼-ÑÑ‡ĞµÑ‚: {spam_score}, ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ: {warnings}\n"
        text += f"  Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ°: {status}\n\n"
    
    if len(blocked) > 10:
        text += f"... Ğ¸ ĞµÑ‰Ğµ {len(blocked) - 10} Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹"
    
    await message.answer(text, parse_mode="HTML")

@router.message(F.text.startswith("/unblock "), admin_filter)
async def unblock_user_command(message: Message):
    """Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    try:
        user_id = int(message.text.split()[1])
        anti_spam.unblock_user(user_id)
        await message.answer(f"âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½.")
    except (ValueError, IndexError):
        await message.answer("âŒ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: /unblock [ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ]")

@router.message(F.text.startswith("/block "), admin_filter)
async def block_user_command(message: Message):
    """Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    try:
        user_id = int(message.text.split()[1])
        anti_spam.block_user(user_id, 0, "Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼")
        await message.answer(f"ğŸš« ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½.")
    except (ValueError, IndexError):
        await message.answer("âŒ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: /block [ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ]")

@router.message(F.text.startswith("/stats "), admin_filter)
async def show_user_stats(message: Message):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    try:
        user_id = int(message.text.split()[1])
        stats = anti_spam.get_user_stats(user_id)
        
        text = f"""ğŸ“Š <b>Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {user_id}:</b>

ğŸ’¬ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ²ÑĞµĞ³Ğ¾: {stats["message_count"]}
ğŸ• Ğ—Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‡Ğ°Ñ: {stats["messages_last_hour"]}
ğŸ¯ Ğ¡Ğ¿Ğ°Ğ¼-ÑÑ‡ĞµÑ‚: {stats["spam_score"]}
âš ï¸ ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğ¹: {stats["warning_count"]}

ğŸš« Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½: {"Ğ”Ğ°" if stats["is_blocked"] else "ĞĞµÑ‚"}"""
        
        if stats["remaining_block_time"] > 0:
            text += f"\nâ° ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ: {stats['remaining_block_time']}Ñ"
        
        await message.answer(text, parse_mode="HTML")
        
    except (ValueError, IndexError):
        await message.answer("âŒ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: /stats [ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ]")

@router.message(F.text == "/security", admin_filter)
async def show_security_stats(message: Message):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸"""
    try:
        from security_monitor import security_monitor
        stats = security_monitor.get_security_stats()
        
        text = f"""ğŸ›¡ï¸ <b>Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸</b>

ğŸ“Š <b>Ğ—Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‡Ğ°Ñ:</b>
â€¢ Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ: {stats["events_last_hour"]}
â€¢ Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸: {stats["blocks_last_hour"]}
â€¢ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ: {stats["messages_last_hour"]}

ğŸ“ˆ <b>ĞĞ±Ñ‰Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:</b>
â€¢ Ğ’ÑĞµĞ³Ğ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹: {stats["total_events"]}
â€¢ Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: {stats["unique_blocked_users"]}

âš ï¸ <b>Ğ¡ĞµÑ€ÑŒĞµĞ·Ğ½Ğ¾ÑÑ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹:</b>
â€¢ ĞĞ¸Ğ·ĞºĞ°Ñ: {stats["severity_breakdown"]["low"]}
â€¢ Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ: {stats["severity_breakdown"]["medium"]}
â€¢ Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ: {stats["severity_breakdown"]["high"]}
â€¢ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ: {stats["severity_breakdown"]["critical"]}

ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:
/events - Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
/ddos - Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° DDoS
/cleanup - Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"""
        
        await message.answer(text, parse_mode="HTML")
    except ImportError:
        await message.answer("âŒ ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½")

@router.message(F.text == "/events", admin_filter)
async def show_recent_events(message: Message):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸"""
    try:
        from security_monitor import security_monitor
        events = security_monitor.get_recent_events(10)
        
        if not events:
            await message.answer("ğŸ“‹ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‚")
            return
        
        text = "ğŸ“‹ <b>ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸:</b>\n\n"
        
        for event in reversed(events[-10:]):  # ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 10 ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
            severity_emoji = {
                "low": "ğŸŸ¢",
                "medium": "ğŸŸ¡", 
                "high": "ğŸŸ ",
                "critical": "ğŸ”´"
            }
            
            time_str = time.strftime("%H:%M:%S", time.localtime(event.timestamp))
            text += f"{severity_emoji.get(event.severity, 'âšª')} <code>{time_str}</code> "
            text += f"<b>{event.event_type}</b>\n"
            text += f"ğŸ‘¤ User: {event.user_id}\n"
            text += f"ğŸ“ {event.details}\n\n"
        
        await message.answer(text, parse_mode="HTML")
    except ImportError:
        await message.answer("âŒ ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½")

@router.message(F.text == "/ddos", admin_filter)
async def check_ddos(message: Message):
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğ½Ğ° Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚ DDoS"""
    try:
        from security_monitor import security_monitor
        is_ddos = security_monitor.detect_ddos_attempt()
        
        if is_ddos:
            text = "ğŸš¨ <b>Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ•!</b> ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ° Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ!\n\n"
            text += "Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ°Ñ DDoS Ğ°Ñ‚Ğ°ĞºĞ° Ğ¸Ğ»Ğ¸ Ğ¼Ğ°ÑÑĞ¾Ğ²Ñ‹Ğ¹ ÑĞ¿Ğ°Ğ¼.\n"
            text += "Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ ÑƒÑĞ¸Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñƒ."
        else:
            text = "âœ… <b>Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ² Ğ½Ğ¾Ñ€Ğ¼Ğµ</b>\n\n"
            text += "ĞŸĞ¾Ğ´Ğ¾Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ½Ğµ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¾."
        
        await message.answer(text, parse_mode="HTML")
    except ImportError:
        await message.answer("âŒ ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½")

@router.message(F.text == "/cleanup", admin_filter) 
async def cleanup_security_data(message: Message):
    """ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸"""
    try:
        from security_monitor import security_monitor
        security_monitor.cleanup_old_data()
        await message.answer("âœ… Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ñ‹")
    except ImportError:
        await message.answer("âŒ ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½")

@router.message(F.text == "/topblocked", admin_filter)
async def show_top_blocked(message: Message):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ¿ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹"""
    try:
        from security_monitor import security_monitor
        top_users = security_monitor.get_top_blocked_users(10)
        
        if not top_users:
            await message.answer("ğŸ“‹ ĞĞµÑ‚ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹")
            return
        
        text = "ğŸ“Š <b>Ğ¢Ğ¾Ğ¿ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹:</b>\n\n"
        
        for i, user_data in enumerate(top_users, 1):
            text += f"{i}. ğŸ‘¤ ID: <code>{user_data['user_id']}</code>\n"
            text += f"   ğŸš« Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ¾Ğº: {user_data['block_count']}\n\n"
        
        await message.answer(text, parse_mode="HTML")
    except ImportError:
        await message.answer("âŒ ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½")

# Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¸Ğ· ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
@router.callback_query(F.data.startswith("quick_confirm_"), admin_filter)
async def quick_confirm_payment(callback: CallbackQuery):
    """Ğ‘Ñ‹ÑÑ‚Ñ€Ğ¾Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ¸Ğ· ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ"""
    order_id = int(callback.data.split("_")[2])
    
    # ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ĞµĞ¼ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñƒ
    await db.update_order_status(order_id, 'paid')
    
    # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ
    order = await db.get_order(order_id)
    if order:
        client_text = f"""âœ… <b>ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ°!</b>

ğŸ“‹ <b>Ğ—Ğ°ĞºĞ°Ğ· #{order.order_number}</b>
ğŸ’° <b>Ğ¡ÑƒĞ¼Ğ¼Ğ°:</b> {order.total_price}â‚¾

Ğ’Ğ°Ñˆ Ğ·Ğ°ĞºĞ°Ğ· Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ Ğ² Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ Ğ¸ Ğ±ÑƒĞ´ĞµÑ‚ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½ Ğ² Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ.
Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾ Ğ·Ğ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºÑƒ! ğŸ‰"""
        
        try:
            await callback.bot.send_message(
                order.user_id,
                client_text,
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="ğŸ”™ Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ", callback_data="back_to_menu")]
                ]),
                parse_mode='HTML'
            )
        except:
            pass
    
    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°
    await callback.message.edit_caption(
        caption=callback.message.caption + "\n\nâœ… <b>ĞĞŸĞ›ĞĞ¢Ğ ĞŸĞĞ”Ğ¢Ğ’Ğ•Ğ Ğ–Ğ”Ğ•ĞĞ</b>",
        parse_mode='HTML'
    )
    await callback.answer("âœ… ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ°")

@router.callback_query(F.data.startswith("quick_reject_"), admin_filter)
async def quick_reject_payment(callback: CallbackQuery):
    """Ğ‘Ñ‹ÑÑ‚Ñ€Ğ¾Ğµ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ¸Ğ· ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ"""
    order_id = int(callback.data.split("_")[2])
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ½Ğ° Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹
    await db.update_order_status(order_id, 'waiting_payment')
    
    # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ
    order = await db.get_order(order_id)
    if order:
        client_text = f"""âŒ <b>ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ°</b>

ğŸ“‹ <b>Ğ—Ğ°ĞºĞ°Ğ· #{order.order_number}</b>
ğŸ’° <b>Ğ¡ÑƒĞ¼Ğ¼Ğ°:</b> {order.total_price}â‚¾

ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ° Ğ¸ Ğ¿Ñ€Ğ¸ÑˆĞ»Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚.
Ğ˜Ğ»Ğ¸ ÑĞ²ÑĞ¶Ğ¸Ñ‚ĞµÑÑŒ Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ Ğ´Ğ»Ñ ÑƒÑ‚Ğ¾Ñ‡Ğ½ĞµĞ½Ğ¸Ñ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹."""
        
        try:
            await callback.bot.send_message(
                order.user_id,
                client_text,
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="ğŸ”™ Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ", callback_data="back_to_menu")]
                ]),
                parse_mode='HTML'
            )
        except:
            pass
    
    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°
    await callback.message.edit_caption(
        caption=callback.message.caption + "\n\nâŒ <b>ĞĞŸĞ›ĞĞ¢Ğ ĞĞ¢ĞšĞ›ĞĞĞ•ĞĞ</b>",
        parse_mode='HTML'
    )
    await callback.answer("âŒ ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ°")

# ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²
@router.callback_query(F.data.startswith("admin_orders_"), admin_filter)
async def show_filtered_orders(callback: CallbackQuery):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹ Ğ¿Ğ¾ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹"""
    parts = callback.data.split("_")
    filter_type = parts[2]  # new, checking, paid, etc.
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞµÑÑ‚ÑŒ Ğ»Ğ¸ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
    if len(parts) > 3 and parts[3] == "page":
        page = int(parts[4])
    else:
        page = 1
    
    await show_filtered_orders_page(callback, filter_type, page)

@router.callback_query(F.data.startswith("admin_orders_page_"), admin_filter)
async def show_filtered_orders_pagination(callback: CallbackQuery):
    """ĞŸĞ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°"""
    parts = callback.data.split("_")
    filter_type = parts[3]  # new, checking, paid, etc.
    page = int(parts[4])
    await show_filtered_orders_page(callback, filter_type, page)

async def show_filtered_orders_page(callback: CallbackQuery, filter_type: str, page: int):
    """ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²"""
    from components.pagination import pagination
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°
    if filter_type == "new":
        orders = await db.get_new_orders()
        title = "ğŸ†• ĞĞ¾Ğ²Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹"
    elif filter_type == "checking":
        orders = await db.get_checking_orders()
        title = "ğŸ’° Ğ—Ğ°ĞºĞ°Ğ·Ñ‹ Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ"
    elif filter_type == "paid":
        orders = await db.get_paid_orders()
        title = "âœ… ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹"
    elif filter_type == "shipping":
        orders = await db.get_shipping_orders()
        title = "ğŸšš Ğ—Ğ°ĞºĞ°Ğ·Ñ‹ Ğ² Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞµ"
    elif filter_type == "delivered":
        orders = await db.get_delivered_orders()
        title = "ğŸ“¦ Ğ”Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹"
    elif filter_type == "cancelled":
        orders = await db.get_cancelled_orders()
        title = "âŒ ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹"
    else:
        orders = await db.get_all_orders()
        title = "ğŸ“‹ Ğ’ÑĞµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹"
    
    if not orders:
        try:
            await callback.message.edit_text(
                f"{title}\n\nĞ—Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾.",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text=_("common.to_admin"), callback_data="admin_panel")]
                ]),
                parse_mode='HTML'
            )
        except Exception:
            await callback.message.delete()
            await callback.message.answer(
                f"{title}\n\nĞ—Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾.",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text=_("common.to_admin"), callback_data="admin_panel")]
                ]),
                parse_mode='HTML'
            )
        return

    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸ (Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¾Ğ¹ 6 ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ)
    pagination.items_per_page = 6
    pagination_info = pagination.paginate(orders, page)
    
    text = f"{title}\n\n"
    text += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
    text += f"{_('admin.total_orders', user_id=callback.from_user.id)} <b>{len(orders)}</b>\n"
    text += pagination.get_page_info_text(pagination_info, user_id=callback.from_user.id)
    text += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
    
    # ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
    for order in pagination_info['items']:
        status_emoji = {
            'waiting_payment': 'â³',
            'payment_check': 'ğŸ’°',
            'paid': 'âœ…',
            'shipping': 'ğŸšš',
            'delivered': 'ğŸ“¦',
            'cancelled': 'âŒ'
        }
        
        emoji = status_emoji.get(order.status, 'â“')
        text += f"{emoji} <b>â„–{order.order_number}</b> - {order.total_price}â‚¾\n"
        text += f"ğŸ“… {order.created_at.strftime('%d.%m %H:%M')} | ğŸ‘¤ ID:{order.user_id}\n\n"

    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹
    def order_button_generator(order, index):
        status_emoji = {
            'waiting_payment': 'â³',
            'payment_check': 'ğŸ’°',
            'paid': 'âœ…',
            'shipping': 'ğŸšš',
            'delivered': 'ğŸ“¦',
            'cancelled': 'âŒ'
        }
        emoji = status_emoji.get(order.status, 'â“')
        return InlineKeyboardButton(
            text=f"{emoji} â„–{order.order_number} - {order.total_price}â‚¾",
            callback_data=f"admin_order_{order.id}"
        )

    additional_buttons = [
        [InlineKeyboardButton(text="ğŸ”™ ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ", callback_data="admin_panel")]
    ]

    keyboard = pagination.create_pagination_keyboard(
        pagination_info=pagination_info,
        callback_prefix=f"admin_orders_page_{filter_type}",
        user_id=callback.from_user.id,
        item_button_generator=order_button_generator,
        additional_buttons=additional_buttons
    )
    
    try:
        await callback.message.edit_text(
            text,
            reply_markup=keyboard,
            parse_mode='HTML'
        )
    except Exception:
        await callback.message.delete()
        await callback.message.answer(
            text,
            reply_markup=keyboard,
            parse_mode='HTML'
        )



# ============== Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ™ ĞĞ”ĞœĞ˜Ğ -> ĞšĞ›Ğ˜Ğ•ĞĞ¢ ==============

@router.callback_query(F.data.startswith("admin_message_client_"), admin_filter)
async def start_message_to_client(callback: CallbackQuery, state: FSMContext):
    """ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºÑƒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ"""
    order_id = int(callback.data.split("_")[3])
    order = await db.get_order(order_id)
    
    if not order:
        await callback.answer("âŒ Ğ—Ğ°ĞºĞ°Ğ· Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", show_alert=True)
        return
    
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸ ID ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ·Ğ°ĞºĞ°Ğ·Ğ°
    await state.update_data(
        client_id=order.user_id,
        order_number=order.order_number,
        order_id=order_id
    )
    await state.set_state(AdminStates.waiting_client_message)
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ·Ñ‹Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    from i18n import i18n
    user_language = i18n.get_user_language(order.user_id)
    language_names = {'ru': 'Ğ ÑƒÑÑĞºĞ¸Ğ¹', 'ka': 'áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜', 'en': 'English'}
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ·Ñ‹Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° (Ğ¿Ğ¾ĞºĞ° Ñ‡Ñ‚Ğ¾ Ñ€ÑƒÑÑĞºĞ¸Ğ¹ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ)
    admin_language = 'ru'  # ĞœĞ¾Ğ¶Ğ½Ğ¾ Ñ€Ğ°ÑÑˆĞ¸Ñ€Ğ¸Ñ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ ÑĞ·Ñ‹ĞºĞ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°
    
    # Ğ’Ğ°Ğ¶Ğ½Ğ¾: Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµĞ¼ Ğ½Ğ° callback
    await callback.answer()
    
    try:
        await callback.message.edit_text(
            _("admin.message_client_form", admin_language).format(
                order_number=order.order_number,
                user_id=order.user_id,
                user_language=language_names.get(user_language, user_language)
            ),
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text=_("common.cancel", admin_language), callback_data=f"admin_order_{order_id}")]
            ]),
            parse_mode='HTML'
        )
    except Exception:
        # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°ĞµÑ‚ÑÑ Ğ¾Ñ‚Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ
        await callback.message.answer(
            _("admin.message_client_form", admin_language).format(
                order_number=order.order_number,
                user_id=order.user_id,
                user_language=language_names.get(user_language, user_language)
            ),
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text=_("common.cancel", admin_language), callback_data=f"admin_order_{order_id}")]
            ]),
            parse_mode='HTML'
        )


# ĞĞ±Ñ‰Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ²ÑĞ·Ğ¸ Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ¼ Ğ¿Ğ¾ ID
@router.callback_query(F.data == "admin_message_client", admin_filter)
async def start_general_message_to_client(callback: CallbackQuery, state: FSMContext):
    """ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºÑƒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ Ğ¿Ğ¾ ID"""
    admin_language = 'ru'  # Ğ¯Ğ·Ñ‹Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
    
    await callback.answer()
    await callback.message.edit_text(
        _("admin.message_client_id_form", admin_language),
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text=_("common.cancel", admin_language), callback_data="admin_panel")]
        ]),
        parse_mode='HTML'
    )
    
    await state.set_state(AdminStates.waiting_client_id)

