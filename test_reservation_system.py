"""
–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤
"""
import asyncio
from datetime import datetime, timedelta
from database import db, init_db

async def test_reservation_system():
    """–¢–µ—Å—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π —Å–∏—Å—Ç–µ–º—ã —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è"""
    
    print("üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è...")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    await init_db()
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    user1_id = 123456
    user2_id = 789012
    product_id = 1  # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Ç–æ–≤–∞—Ä —Å ID 1 —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    
    try:
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        await db.add_user(user1_id, "testuser1", "Test User 1")
        await db.add_user(user2_id, "testuser2", "Test User 2")
        
        # –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—ã –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º
        await db.clear_cart(user1_id)
        await db.clear_cart(user2_id)
        
        print("‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–∞
        product = await db.get_product(product_id)
        if not product:
            print("‚ùå –¢–æ–≤–∞—Ä —Å ID 1 –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.")
            return
        
        initial_stock = product.stock_quantity
        print(f"üì¶ –ù–∞—á–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ: {initial_stock}")
        
        # –¢–µ—Å—Ç 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É –ø–µ—Ä–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        print("\nüß™ –¢–µ—Å—Ç 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É")
        success = await db.add_to_cart(user1_id, product_id, 2)
        if success:
            print("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1 —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–∏–ª 2 —à—Ç. —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É")
        else:
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 1")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        available = await db.get_available_product_quantity(product_id)
        reserved = await db.get_reserved_quantity(product_id)
        print(f"üìä –î–æ—Å—Ç—É–ø–Ω–æ: {available}, –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ: {reserved}")
        
        # –¢–µ—Å—Ç 2: –í—Ç–æ—Ä–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ
        print("\nüß™ –¢–µ—Å—Ç 2: –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –∑–∞ —Ç–æ–≤–∞—Ä")
        success = await db.add_to_cart(user2_id, product_id, available + 1)  # –ë–æ–ª—å—à–µ —á–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ
        if not success:
            print("‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2 –Ω–µ —Å–º–æ–≥ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞")
        else:
            print("‚ùå –û—à–∏–±–∫–∞! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2 —Å–º–æ–≥ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ")
        
        # –¢–µ—Å—Ç 3: –í—Ç–æ—Ä–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        if available > 0:
            success = await db.add_to_cart(user2_id, product_id, min(available, 1))
            if success:
                print("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2 —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–∏–ª –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ")
            else:
                print("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2 –Ω–µ —Å–º–æ–≥ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä–∑–∏–Ω—ã
        print("\nüìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä–∑–∏–Ω:")
        cart1 = await db.get_cart(user1_id)
        cart2 = await db.get_cart(user2_id)
        
        print(f"üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 1: {len(cart1)} —Ç–æ–≤–∞—Ä–æ–≤")
        for item in cart1:
            remaining_time = (item.reserved_until - datetime.now()).total_seconds() / 60 if item.reserved_until else 0
            print(f"  - {item.name}: {item.quantity} —à—Ç., –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ {remaining_time:.1f} –º–∏–Ω")
        
        print(f"üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 2: {len(cart2)} —Ç–æ–≤–∞—Ä–æ–≤")
        for item in cart2:
            remaining_time = (item.reserved_until - datetime.now()).total_seconds() / 60 if item.reserved_until else 0
            print(f"  - {item.name}: {item.quantity} —à—Ç., –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ {remaining_time:.1f} –º–∏–Ω")
        
        # –¢–µ—Å—Ç 4: –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤
        print("\nüß™ –¢–µ—Å—Ç 4: –ò–º–∏—Ç–∞—Ü–∏—è –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞")
        print("‚è≥ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π —Ä–µ–∑–µ—Ä–≤...")
        
        # –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ –¥–µ–ª–∞–µ–º —Ä–µ–∑–µ—Ä–≤ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–º
        await db.execute(
            "UPDATE cart SET reserved_until = CURRENT_TIMESTAMP - INTERVAL '1 minute' WHERE user_id = $1", 
            user1_id
        )
        
        # –û—á–∏—â–∞–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—ã
        await db.cleanup_expired_reservations()
        print("‚úÖ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ä–µ–∑–µ—Ä–≤ –∏—Å—á–µ–∑
        cart1_after_cleanup = await db.get_cart(user1_id)
        if len(cart1_after_cleanup) == 0:
            print("‚úÖ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—ã —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã")
        else:
            print("‚ùå –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—ã –Ω–µ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–æ–≤–∞—Ä —Å–Ω–æ–≤–∞ –¥–æ—Å—Ç—É–ø–µ–Ω
        available_after = await db.get_available_product_quantity(product_id)
        print(f"üì¶ –î–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏: {available_after}")
        
        print("\nüéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        import traceback
        traceback.print_exc()
    
    finally:
        # –û—á–∏—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        await db.clear_cart(user1_id)
        await db.clear_cart(user2_id)
        await db.close_pool()

if __name__ == "__main__":
    asyncio.run(test_reservation_system())